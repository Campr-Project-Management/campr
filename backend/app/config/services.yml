parameters:
    emails:
        from_email:
            info: "info@campr.biz"
            no-reply: "no-reply@campr.biz"
        from_name:
            info: "Info Campr"
            no-reply: "No Reply"
    adapters:
        placeholder.driver.local: "local_adapter"
        placeholder.driver.dropbox: "dropbox_adapter"

services:
    app.service.base_client:
        abstract: true
        arguments:
            - "@request_stack"
            - "%domain%"

    app.service.team:
        class: AppBundle\Services\TeamService
        parent: app.service.base_client
        arguments: ["@redis.client"]

    app.jwt_signer:
        class: Lcobucci\JWT\Signer\Hmac\Sha512

    app.jwt_builder:
        class: Lcobucci\JWT\Builder

    app.jwt_parser:
        class: Lcobucci\JWT\Parser

    app.service.mailer:
        class: AppBundle\Services\MailerService
        arguments:
            - "@mailer"
            - "@twig"
            - "%emails%"
            -
                activation_token_expiration_number: '%activation_token_expiration_number%'

    app.service.automailer.plugin.redis:
        class: AppBundle\Services\AutomailerRedisPlugin
        public: false
        arguments:
            - '%kernel.environment%'
            - '@redis.client'
        tags:
            - { name: 'swiftmailer.default.plugin' }

    app.service.user:
        class: AppBundle\Services\UserService
        parent: app.service.base_client
        arguments: ["@doctrine.orm.entity_manager", "@security.password_encoder", "@router"]

    app.service.request_parser:
        class: AppBundle\Services\RequestParserService

    app.service.data_table:
        class: AppBundle\Services\DataTableService
        arguments:
            - "@doctrine.orm.entity_manager"
            - "@app.service.request_parser"
            - "@jms_serializer"
            - "@fos_js_routing.encoder"
            - "@fos_js_routing.normalizer"

    app.service.import:
        class: AppBundle\Services\ImportService
        arguments:
            - "@doctrine.orm.entity_manager"
            - "@validator"

    app.service.export:
            class: AppBundle\Services\ExportService

    app.service.chat:
        class: AppBundle\Services\ChatService
        arguments:
            - "@doctrine.orm.entity_manager"

    app.service.calendar:
        class: AppBundle\Services\CalendarService
        arguments:
            - "@doctrine.orm.entity_manager"

    app.service.rasci_matrix:
        class: AppBundle\Services\RasciMatrixService
        arguments:
            - "@doctrine.orm.entity_manager"
            - "@jms_serializer"

    redis.client:
        class: Predis\Client
        arguments:
            -
                host: '%redis_host%'

    session.handler.redis:
        class: Snc\RedisBundle\Session\Storage\Handler\RedisSessionHandler
        arguments:
            - '@redis.client'

    app.service.filesystem:
        class: AppBundle\Services\FileSystemService
        arguments:
            - "@knp_gaufrette.filesystem_map"

    app.service.chat_topic:
        class: AppBundle\Topic\ChatTopic
        arguments:
            - "@app.service.chat"
            - "@gos_web_socket.websocket.client_manipulator"
            - "@doctrine.orm.entity_manager"
        tags:
            - { name: gos_web_socket.topic }

    app.service.chat_user_topic:
        class: AppBundle\Topic\ChatUserTopic
        arguments:
            - "@app.service.chat"
            - "@gos_web_socket.websocket.client_manipulator"
            - "@doctrine.orm.entity_manager"
        tags:
            - { name: gos_web_socket.topic }

    app.service.pdf:
        class: AppBundle\Services\PDF
        arguments:
            - '@request_stack'
            - '@security.token_storage'
            - '%app.pdf.google_chrome%'
            - '%app.pdf.google_chrome_arguments%'
            - '%app.pdf.service_url%'

    app.service.wbs:
        class: AppBundle\Services\WBSService
        arguments:
            - '@doctrine.orm.default_entity_manager'

    app.calculator.phase_actual_dates:
        class: Component\WorkPackage\Calculator\PhaseActualDatesCalculator
        arguments:
            - '@app.repository.work_package'

    app.formatter.money:
        class: AppBundle\Formatter\MoneyFormatter

    app.templating.helper.format_money:
        class: AppBundle\Templating\Helper\FormatMoneyHelper
        public: false
        arguments:
            - '@app.formatter.money'

### REPOSITORIES ###
    app.repository.work_package:
        class: AppBundle\Repository\WorkPackageRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\WorkPackage }

    app.repository.work_package_status:
        class: AppBundle\Repository\WorkPackageStatusRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\WorkPackageStatus }

    app.repository.rasci:
        class: AppBundle\Repository\RasciRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\Rasci }

    app.repository.project_user:
        class: AppBundle\Repository\ProjectUserRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\ProjectUser }

    app.repository.team:
        class: AppBundle\Repository\TeamRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\Team }

    app.repository.currency:
        class: AppBundle\Repository\CurrencyRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\Currency }

    app.repository.risk:
        class: AppBundle\Repository\RiskRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\Risk }

    app.repository.opportunity:
        class: AppBundle\Repository\OpportunityRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\Opportunity }

    app.repository.measure:
        class: AppBundle\Repository\MeasureRepository
        arguments: ~
        tags:
            - { name: app.repository, class: AppBundle\Entity\Measure }

### MENU BUILDER ###
    app.admin.menu.builder:
        class: AppBundle\Menu\MenuBuilder
        arguments:
            - "@router"
            - "@security.token_storage"
            - "@security.authorization_checker"
            - "@translator"
            - "@knp_menu.factory"
        tags:
            - { name: knp_menu.menu_builder, method: createAdminAppMenu, alias: admin_app }

### FORM TYPES ###
    app.form.filesystem.create_type:
        class: AppBundle\Form\FileSystem\CreateType
        arguments:
            - "%adapters%"
        tags:
            - { name: form.type }

    app.form.filesystem.media_upload_type:
        class: AppBundle\Form\FileSystem\MediaUploadType
        arguments:
            - "@security.token_storage"
        tags:
            - { name: form.type }

    app.form.project.api_type:
        class: AppBundle\Form\Project\ApiType
        arguments:
            - "@security.token_storage"
        tags:
            - { name: form.type }

    app.form.workpackage.upload_media_type:
        class: AppBundle\Form\WorkPackage\UploadMediaType
        arguments:
            - "@security.token_storage"
        tags:
            - { name: form.type }

    app.form.cost.create_type:
        class: AppBundle\Form\Cost\CreateType
        arguments:
            - "@doctrine.orm.entity_manager"
        tags:
            - { name: form.type }

    app.form.cost.api_create_type:
        class: AppBundle\Form\Cost\ApiCreateType
        arguments:
            - "@doctrine.orm.entity_manager"
        tags:
            - { name: form.type }

### LISTENERS ###
    # gedmo listeners are found here
    # https://github.com/Atlantic18/DoctrineExtensions/blob/a3d7ad1cf41f397104bc16d99c0a91fd7b2e6d38/doc/symfony2.md
    gedmo.listener.sluggable:
        class: Gedmo\Sluggable\SluggableListener
        tags:
            - { name: doctrine.event_subscriber, connection: default }
        calls:
            - [ setAnnotationReader, [ "@annotation_reader" ] ]

    gedmo.listener.sortable:
        class: Gedmo\Sortable\SortableListener
        tags:
            - { name: doctrine.event_subscriber, connection: default }
        calls:
            - [ setAnnotationReader, [ "@annotation_reader" ] ]

    gedmo.listener.timestampable:
        class: Gedmo\Timestampable\TimestampableListener
        tags:
            - { name: doctrine.event_subscriber, connection: default }
        calls:
            - [ setAnnotationReader, [ "@annotation_reader" ] ]

    app.listener.user:
        class: AppBundle\EventListener\UserListener
        arguments:
            - '@security.password_encoder'
        tags :
            - { name: doctrine.event_listener, event: onFlush }

    app.listener.project_user:
        class: AppBundle\EventListener\ProjectUserListener
        tags :
            - { name: doctrine.event_listener, event: onFlush }

    app.listener.media:
        class: AppBundle\EventListener\MediaListener
        arguments:
            - '@app.service.filesystem'
        tags :
            - { name: doctrine.event_listener, event: prePersist }
            - { name: doctrine.event_listener, event: preRemove }

    app.listener.db_logger:
        class: AppBundle\EventListener\DBLogger
        tags:
            - { name: doctrine.event_listener, event: onFlush }
        arguments:
            - "@security.token_storage"

    app.listener.message:
        class: AppBundle\EventListener\MessageListener
        tags :
            - { name: doctrine.event_listener, event: prePersist }

    app.listener.request:
        class: AppBundle\EventListener\RequestListener
        tags:
            - { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }

    app.listener.ajax_response:
        class: AppBundle\EventListener\AjaxResponseListener
        tags:
            - { name: kernel.event_listener, event: kernel.response, method: onKernelResponse }

    app.subscriber.api_problem:
        class: AppBundle\EventListener\ApiExceptionSubscriber
        arguments:
            - '@service_container'
        tags:
            - { name: kernel.event_subscriber }

    app.listener.work_package:
        class: AppBundle\EventListener\WorkPackageListener
        tags :
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }

    app.listener.project:
        class: AppBundle\EventListener\ProjectListener
        tags :
            - { name: doctrine.event_listener, event: prePersist }
            - { name: doctrine.event_listener, event: postLoad }
        arguments:
            - '@security.token_storage'
            - '@translator'

    app.subscriber.work_package:
        class: AppBundle\EventListener\WorkPackageSubscriber
        arguments:
            - '@app.repository.rasci'
            - '@app.repository.project_user'
            - '@app.repository.work_package'
            - '@app.repository.work_package_status'
            - '@app.calculator.phase_actual_dates'
        tags:
            - { name: kernel.event_subscriber }

    app.subscriber.rasci:
        class: AppBundle\EventListener\RasciSubscriber
        arguments:
            - '@app.repository.work_package'
        tags:
            - { name: kernel.event_subscriber }

### EXTENSIONS ###
    app.twig.extension.app:
        class: AppBundle\Twig\AppExtension
        public: false
        arguments:
            - '%show_tracking_code%'
        tags:
            - { name: twig.extension }

    app.twig.extension.currency:
        class: AppBundle\Twig\CurrencyExtension
        public: false
        tags:
            - { name: twig.extension }

    app.twig.extension.format_money:
        class: AppBundle\Twig\FormatMoneyExtension
        public: false
        arguments:
            - '@app.templating.helper.format_money'
        tags:
            - { name: twig.extension }

### VOTERS ###
    app.admin_voter:
        class: AppBundle\Security\AdminVoter
        tags:
            - { name: security.voter, priority: 255 }
        public: false

    app.calendar_voter:
        class: AppBundle\Security\CalendarVoter
        arguments:
            - '@doctrine.orm.entity_manager'
        tags:
            - { name: security.voter }
        public: false

    app.distribution_list_voter:
        class: AppBundle\Security\DistributionListVoter
        tags:
            - { name: security.voter }
        public: false

    app.meeting_voter:
        class: AppBundle\Security\MeetingVoter
        tags:
            - { name: security.voter }
        public: false

    app.workpackage_voter:
        class: AppBundle\Security\WorkPackageVoter
        arguments:
            - '@doctrine.orm.entity_manager'
        tags:
            - { name: security.voter }
        public: false

    app.project_voter:
        class: AppBundle\Security\ProjectVoter
        arguments:
            - '@doctrine.orm.entity_manager'
        tags:
            - { name: security.voter }
        public: false

### Authentication ###
    app_api.authentication.handler.success:
        class: AppBundle\Services\Authentication\SuccessHandler
        arguments:
            - "@translator.default"

    app_api.authentication.handler.failure:
        class: AppBundle\Services\Authentication\FailureHandler
        arguments:
            - "@translator.default"

    app_api.authentication.handler.user_provider:
        class: AppBundle\Services\Authentication\UserProvider
        arguments:
            - "@doctrine.orm.entity_manager"

    app_api.authentication.handler.authenticator:
        class: AppBundle\Services\Authentication\Authenticator
        public: false

### VALIDATORS ###
    app.user_invited_validator:
        class: MainBundle\Validator\Constraints\TeamMember\UserInvitedValidator
        arguments:
            - '@doctrine.orm.entity_manager'
        tags:
            - { name: validator.constraint_validator }

    app.self_imvite_validator:
        class: MainBundle\Validator\Constraints\TeamMember\SelfInviteValidator
        arguments:
            - '@doctrine.orm.entity_manager'
        tags:
            - { name: validator.constraint_validator }

    app.team_member_validator:
        class: MainBundle\Validator\Constraints\TeamMember\ActiveMemberValidator
        arguments:
            - '@doctrine.orm.entity_manager'
        tags:
            - { name: validator.constraint_validator }

### ROUTING ###
    app.routing.loader:
        class: AppBundle\Routing\Loader
        public: false
        arguments:
            - '@file_locator'
            - '@sensio_framework_extra.routing.loader.annot_class'
            - '%kernel.team_slug%'
            - '%kernel.environment%'
        tags:
            - { name: routing.loader }
