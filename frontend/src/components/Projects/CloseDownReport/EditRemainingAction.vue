<template>
    <div class="row">
        <div class="col-md-6">
            <div class="create-meeting page-section">
                <!-- /// Header /// -->
                <div class="header flex-v-center">
                    <div>
                        <router-link :to="{name: 'project-close-down-report'}" class="small-link">
                            <i class="fa fa-angle-left"></i>
                            {{ translateText('message.back_to') }} {{ translateText('message.close_down_report') }}
                        </router-link>
                        <h1>{{ translateText('message.edit_remaining_action') }}</h1>
                    </div>
                </div>
                <!-- /// End Header /// -->
                
                <div class="form">
                    <!-- /// Title and Description /// -->
                    <div class="form-group">
                        <input-field type="text" v-bind:label="translateText('placeholder.title')" v-model="title" v-bind:content="title" />
                        <error
                            v-if="validationMessages.title && validationMessages.title.length"
                            v-for="message in validationMessages.title"
                            :message="message" />
                    </div>

                    <div class="form-group">
                        <div class="vueditor-holder">
                            <div class="vueditor-header">{{ translateText('placeholder.description') }}</div>
                            <Vueditor id="descriptionEditor" ref="description" />
                        </div>
                    </div>
                    <!-- /// Title and Description /// -->

                    <!-- /// Responsible and Due Date /// -->
                    <div class="row">
                        <div class="form-group last-form-group">
                            <div class="col-md-6">
                                <member-search v-model="responsible" v-bind:placeholder="translateText('placeholder.responsible')" v-bind:singleSelect="true"></member-search>
                            </div>
                            <div class="col-md-6">
                                <div class="input-holder right">
                                    <label class="active">{{ translateText('label.due_date') }}</label>
                                    <datepicker v-model="dueDate" format="dd-MM-yyyy" />
                                    <calendar-icon fill="middle-fill"/>
                                </div>
                            </div>
                        </div>
                    </div> 
                    <!-- /// End Responsible and Due Date /// -->  

                    <hr class="double">               

                    <!-- /// Actions /// -->
                    <div class="flex flex-space-between">
                        <router-link :to="{name: 'project-close-down-report'}" class="btn-rounded btn-auto btn-auto disable-bg">{{ translateText('button.cancel') }}</router-link>
                        <a @click="saveAction" class="btn-rounded btn-auto second-bg">{{ translateText('button.save') }}</a>
                    </div>
                    <!-- /// End Actions /// -->
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import InputField from '../../_common/_form-components/InputField';
import datepicker from '../../_common/_form-components/Datepicker';
import CalendarIcon from '../../_common/_icons/CalendarIcon';
import MemberSearch from '../../_common/MemberSearch';
import moment from 'moment';
import {mapActions, mapGetters} from 'vuex';
import {createEditor} from 'vueditor';
import vueditorConfig from '../../_common/vueditorConfig';
import Error from '../../_common/_messages/Error.vue';
import router from '../../../router';

export default {
    components: {
        InputField,
        datepicker,
        CalendarIcon,
        MemberSearch,
        moment,
        Error,
    },
    methods: {
        ...mapActions(['getCloseDownAction', 'editCloseDownAction']),
        translateText: function(text) {
            return this.translate(text);
        },
        saveAction: function() {
            this.editCloseDownAction({
                id: this.currentCloseDownAction.id,
                title: this.title,
                description: this.descriptionEditor.getContent(),
                responsibility: this.responsible.length > 0 ? this.responsible[0] : null,
                dueDate: moment(this.dueDate, 'DD-MM-YYYY').format('DD-MM-YYYY'),
            }).then(
                (response) => {
                    if (response && response.body && !response.body.error) {
                        router.push({
                            name: 'project-close-down-report',
                            params: {
                                id: this.$route.params.id,
                            },
                        });
                    }
                },
            );
        },
    },
    computed: {
        ...mapGetters({currentCloseDownAction: 'currentCloseDownAction', validationMessages: 'validationMessages'}),
    },
    created() {
        if (this.$route.params.actionId) {
            this.getCloseDownAction(this.$route.params.actionId);
        }
        setTimeout(() => {
            this.descriptionEditor = createEditor(document.getElementById('descriptionEditor'), {...vueditorConfig, id: 'descriptionEditor'});
        }, 100);
    },
    watch: {
        currentCloseDownAction(value) {
            this.title = this.currentCloseDownAction.title;
            this.descriptionEditor.setContent(this.currentCloseDownAction.description);
            this.responsible.push(this.currentCloseDownAction.responsibility);
            this.dueDate = new Date(this.currentCloseDownAction.dueDate);
        },
    },
    data() {
        return {
            title: '',
            responsible: [],
            dueDate: new Date(),
            descriptionEditor: null,
        };
    },
};
</script>

<style lang="scss">
    @import '../../../css/datepicker.scss';
</style>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">

</style>
