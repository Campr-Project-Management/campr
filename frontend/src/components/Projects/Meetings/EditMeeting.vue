<template>
    <div class="row">
        <!-- /// Modals /// -->
        <meeting-modals ref="meetingmodal"
            v-bind:editObjectiveModal="showEditObjectiveModal"
            v-bind:deleteObjectiveModal="showDeleteObjectiveModal"
            v-bind:objectiveObject="editObjectiveObject"
            v-bind:editAgendaModal="showEditAgendaModal"
            v-bind:deleteAgendaModal="showDeleteAgendaModal"
            v-bind:agendaObject="editAgendaObject"
            v-bind:editDecisionModal="showEditDecisionModal"
            v-bind:deleteDecisionModal="showDeleteDecisionModal"
            v-bind:decisionObject="editDecisionObject"
            v-bind:editTodoModal="showEditTodoModal"
            v-bind:deleteTodoModal="showDeleteTodoModal"
            v-bind:todoObject="editTodoObject"
            v-bind:editInfoModal="showEditInfoModal"
            v-bind:deleteInfoModal="showDeleteInfoModal"
            v-bind:infoObject="editInfoObject"
            v-on:input="setModals"
            @agendaChanged="refreshAgendaTable" />
        <modal v-if="deleteMeetingModal" @close="deleteMeetingModal = false">
            <p class="modal-title">{{ translate('message.delete_meeting') }}</p>
            <div class="flex flex-space-between">
                <a href="javascript:void(0)" @click="deleteMeetingModal = false" class="btn-rounded btn-auto">{{ translate('message.no') }}</a>
                <a href="javascript:void(0)" @click="deleteMeeting()" class="btn-rounded btn-empty btn-auto danger-color danger-border">{{ translate('message.yes') }}</a>
            </div>
        </modal>

        <edit-distribution-list-modal
            v-if="editDistributionListModal"
            @close="editDistributionListModal = null"
            v-on:distributionListUpdated="distributionListUpdated"
            :distribution-id="editDistributionListModal" />
        <!-- /// End Modals /// -->

        <div class="col-md-6">
            <div class="create-meeting page-section">
                <!-- /// Header /// -->
                <div class="header flex-v-center">
                    <div>
                        <router-link :to="{name: 'project-meetings'}" class="small-link">
                            <i class="fa fa-angle-left"></i>
                            {{ translate('message.back_to_meetings') }}
                        </router-link>
                        <h1>{{ translate('message.edit') }} <b>{{ translateMeetingName(meeting.name) }}</b></h1>
                    </div>
                </div>
                <!-- /// End Header /// -->

                <div class="form">
                    <!-- /// Meeting Distribution List (Event Name) and Category /// -->
                    <div class="row">
                        <div class="form-group last-form-group">
                            <div class="col-md-6">
                                <select-field
                                    v-bind:title="translate('placeholder.distribution_list')"
                                    v-bind:options="distributionListsForSelect"
                                    v-model="details.distributionList"/>
                                <error at-path="distributionLists"/>
                            </div>
                            <div class="col-md-6">
                                <select-field
                                    v-bind:title="translate('label.category')"
                                    v-bind:options="meetingCategoriesForSelect"
                                    v-model="details.category"/>
                                <error at-path="meetingCategory"/>
                            </div>
                        </div>
                    </div>
                    <!-- /// End Meeting Distribution List (Event Name) and Category /// -->

                    <hr class="double">

                    <!-- /// Meeting Schedule /// -->
                    <h3>{{ translate('message.schedule') }}</h3>
                    <div class="row">
                        <div class="form-group form-group">
                            <div class="col-md-6">
                                <div class="input-holder right">
                                    <label class="active">{{ translate('label.select_date') }}</label>
                                    <date-field v-model="schedule.meetingDate"/>
                                </div>
                                <error at-path="date"/>
                            </div>
                            <div class="col-md-3">
                                <div class="input-holder right">
                                    <label class="active">{{ translate('label.start_time') }}</label>
                                    <DataPicker v-model="schedule.startTime"
                                                format="HH:mm"
                                                type="time"
                                                placeholder="HH:mm"
                                                :minute-step="15"
                                                lang="en"
                                    />
                                </div>
                                <error at-path="start"/>
                            </div>
                            <div class="col-md-3">
                                <div class="input-holder right">
                                    <label class="active">{{ translate('label.finish_time') }}</label>
                                    <DataPicker v-model="schedule.endTime"
                                                type="time"
                                                format="HH:mm"
                                                :minute-step="15"
                                                placeholder="HH:mm"
                                                lang="en"
                                    />
                                </div>
                                <error at-path="end"/>
                            </div>
                        </div>
                    </div>
                    <!-- /// End Meeting Schedule /// -->

                    <hr class="double">

                    <!-- /// Meeting Location /// -->
                    <h3>{{ translate('message.location') }}</h3>
                    <input-field
                            type="text"
                            :label="translate('placeholder.location')"
                            v-model="location"/>
                    <!-- /// End Meeting Location /// -->

                    <hr class="double">

                    <!-- /// Meeting Objectives /// -->
                    <h3>{{ translate('message.objectives') }}</h3>
                    <ul class="action-list" v-if="meeting.meetingObjectives">
                        <li v-for="objective in meeting.meetingObjectives">
                            <div class="list-item-description">
                                {{ objective.description }}
                            </div>
                            <div class="list-item-actions">
                                <a @click="initEditObjective(objective)" class="btn-icon" v-tooltip.top-center="translate('message.edit_objective')"><edit-icon fill="second-fill"></edit-icon></a>
                                <a @click="initDeleteObjective(objective)" class="btn-icon" v-tooltip.top-center="translate('message.delete_objective')"><delete-icon fill="danger-fill"></delete-icon></a>
                            </div>
                        </li>
                    </ul>
                    <div class="form-group">
                        <input-field type="text" v-bind:label="translate('message.new_objective')" v-model="objectiveDescription" :content="objectiveDescription" />
                        <error scope="meeting-objective" at-path="description"/>
                    </div>
                    <div class="flex flex-direction-reverse">
                        <a @click="addObjective()" class="btn-rounded btn-auto">{{ translate('message.add_new_objective') }}</a>
                    </div>
                    <!-- /// End Meeting Objectives /// -->

                    <hr class="double">

                    <!-- /// Meeting Agenda /// -->
                    <h3>{{ translate('message.agenda') }}</h3>
                    <div class="overflow-hidden">
                        <scrollbar class="table-wrapper customScrollbar">
                            <div class="scroll-wrapper">
                                <table class="table table-striped table-responsive">
                                    <thead>
                                        <tr>
                                            <th>{{ translate('table_header_cell.topic') }}</th>
                                            <th>{{ translate('table_header_cell.responsible') }}</th>
                                            <th>{{ translate('table_header_cell.start') }}</th>
                                            <th>{{ translate('table_header_cell.duration') }}</th>
                                            <th>{{ translate('table_header_cell.actions') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody v-if="meetingAgendas">
                                        <tr v-for="agenda in meetingAgendas.items">
                                            <td class="topic">{{ agenda.topic }}</td>
                                            <td>
                                                <div class="avatars collapse in" id="tp-meeting-20032017-1">
                                                    <div>
                                                        <div class="avatar" v-tooltip.top-center="agenda.responsibilityFullName" :style="{ backgroundImage: 'url('+agenda.responsibilityAvatarUrl+')' }"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ agenda.start }}</td>
                                            <td>{{ agenda.duration }} {{ translate('message.min') }}</td>
                                            <td>
                                                <div class="text-right">
                                                    <a @click="initEditAgenda(agenda)"  class="btn-icon" v-tooltip.top-center="translate('label.edit_topic')"><edit-icon fill="second-fill"></edit-icon></a>
                                                    <a @click="initDeleteAgenda(agenda)" class="btn-icon" v-tooltip.top-center="translate('label.delete_topic')"><delete-icon fill="danger-fill"></delete-icon></a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </scrollbar>
                    </div>
                    <div v-if="meetingAgendas && meetingAgendas.items" class="flex flex-direction-reverse flex-v-center">
                        <div class="pagination flex flex-center" v-if="meetingAgendas && meetingAgendas.totalItems > 0">
                            <span v-if="agendasPages > 1" v-for="page in agendasPages" v-bind:class="{'active': page == agendasActivePage}" @click="changeAgendasPage(page)">{{ page }}</span>
                        </div>
                        <div>
                            <span class="pagination-info">{{ translate('message.displaying') }} {{ meetingAgendas.items.length }} {{ translate('message.results_out_of') }} {{ meetingAgendas.totalItems }}</span>
                        </div>
                    </div>
                    <hr>
                    <div class="form-group">
                        <input-field type="text" v-bind:label="translate('placeholder.topic')" v-model="agenda.topic" v-bind:content="agenda.topic" />
                        <error at-path="topic"/>
                    </div>
                    <div class="row">
                        <div class="form-group form-group">
                            <div class="col-md-6">
                                <member-search  v-bind:selectedUser="agenda.responsibilityFullName" v-model="agenda.responsibility" v-bind:placeholder="translate('placeholder.responsible')" v-bind:singleSelect="true"></member-search>
                            </div>
                            <div class="col-md-6">
                                <input-field type="number" v-bind:label="`${translate('placeholder.duration')} (${translate('placeholder.minutes')})`" v-model="agenda.duration" v-bind:content="agenda.duration" v-bind:min="0" />
                                <error at-path="duration"/>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-direction-reverse">
                        <a @click="addAgenda()" class="btn-rounded btn-auto">{{ translate('message.add_new_topic') }}</a>
                    </div>
                    <!-- /// End Meeting Objectives /// -->

                    <hr class="double">

                    <!-- /// Meeting Documents /// -->
                    <h3>{{ translate('message.documents') }}</h3>
                    <attachments
                            v-model="medias"
                            label="button.add_document"
                            :max-file-size="projectMaxUploadFileSize"
                            @uploading="onUploading"/>
                    <!-- /// End Meeting Documents /// -->

                    <hr class="double">

                    <!-- /// Decisions /// -->
                    <h3>{{ translate('message.decisions') }}</h3>

                    <div class="entries-wrapper" v-if="meeting.openDecisions">
                        <div class="entry" v-for="decision in meeting.openDecisions">
                            <div class="entry-header flex flex-space-between flex-v-center">
                                <div class="entry-title">
                                    <h4>{{ decision.title }}</h4>
                                    | {{ translate('message.due_date') }}: <b>{{ decision.dueDate | moment('DD.MM.YYYY') }}</b>
                                    | {{ translate('message.status') }}:
                                    <b v-if="decision.isDone" class="success-color">{{ translate('choices.done') }}</b>
                                    <b v-else class="danger-color">{{ translate('choices.undone') }}</b>
                                </div>
                                <div class="entry-buttons">
                                    <button @click="initEditDecision(decision)" class="btn btn-rounded second-bg btn-auto btn-md" data-toggle="modal" type="button">{{ translate('message.edit') }}</button>
                                    <button @click="initDeleteDecision(decision)" type="button" class="btn btn-rounded btn-auto btn-md danger-bg" >{{ translate('message.delete') }}</button>
                                </div>
                            </div>
                            <div class="entry-responsible flex flex-v-center" v-if="decision.responsibility">
                                <user-avatar
                                        :name="decision.responsibilityFullName"
                                        :url="decision.responsibilityAvatarUrl"/>
                                <div>
                                    {{ translate('message.responsible') }}:
                                    <b>{{ decision.responsibilityFullName }}</b>
                                </div>
                            </div>
                            <div class="entry-body" v-html="decision.description"></div>
                            <div class="attachments">
                                <template v-for="(media, index) in decision.medias">
                                    <div
                                            class="attachment"
                                            v-if="media"
                                            :key="index">
                                        <view-icon/>
                                        <span class="attachment-name">
                                            <a @click="getMediaFile(media)" v-if="media.id">{{ media.name }}</a>
                                            <span v-else>{{ media.name }}</span>
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <meeting-decision-form
                            v-model="decision"
                            @uploading="onDecisionUploading"
                            :error-messages="decisionErrors"/>

                    <div class="row">
                        <div class="form-group last-form-group">
                            <div class="col-md-6 col-md-offset-6">
                                <div class="flex flex-direction-reverse">
                                    <a @click="addDecision()" class="btn-rounded btn-auto">{{ translate('message.add_new_decision') }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /// End Decisions /// -->

                    <hr class="double">

                    <!-- /// ToDos /// -->
                    <h3>{{ translate('message.todos') }}</h3>

                    <div class="entries-wrapper" v-if="meeting.openTodos">
                        <div class="entry" v-for="todo in meeting.openTodos">
                            <div class="entry-header flex flex-space-between flex-v-center">
                                <div class="entry-title">
                                    <h4>{{ todo.title }}</h4>  | {{ translate('message.due_date') }}: <b>{{ todo.dueDate | moment('DD.MM.YYYY') }}</b> | {{ translate('message.status') }}: <b v-if="todo.status">{{ translate(todo.statusName) }}</b><b v-else>-</b>
                                </div>
                                <div class="entry-buttons">
                                    <button @click="initEditTodo(todo)"  class="btn btn-rounded second-bg btn-auto btn-md" data-toggle="modal" type="button">{{ translate('message.edit') }}</button>
                                    <button @click="initDeleteTodo(todo)"  type="button" class="btn btn-rounded btn-auto btn-md danger-bg" >{{ translate('message.delete') }}</button>
                                </div>
                            </div>
                            <div class="entry-responsible flex flex-v-center">
                                <user-avatar
                                        size="small"
                                        :url="todo.responsibilityAvatarUrl"
                                        :name="todo.responsibilityFullName"/>
                                <div>
                                    {{ translate('message.responsible') }}:
                                    <b>{{ todo.responsibilityFullName }}</b>
                                </div>
                            </div>
                            <div class="entry-body" v-html="todo.description"></div>
                        </div>
                    </div>

                    <input-field type="text" v-bind:label="translate('placeholder.topic')" v-model="todo.title" v-bind:content="todo.title" />
                    <error at-path="title" scope="todo"/>
                    <div class="form-group">
                        <editor
                            id="todo-description"
                            height="200px"
                            label="placeholder.todo_description"
                            v-model="todo.description" />
                        <error at-path="description" scope="todo"/>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <div class="col-md-6">
                                <member-search v-model="todo.responsibility" v-bind:placeholder="translate('placeholder.responsible')" v-bind:singleSelect="true"></member-search>
                            </div>
                            <div class="col-md-6">
                                <div class="input-holder right">
                                    <label class="active">{{ translate('label.due_date') }}</label>
                                    <date-field v-model="todo.dueDate"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group last-form-group">
                            <div class="col-md-6">
                                <select-field
                                    v-bind:title="translate('label.select_status')"
                                    v-bind:options="todoStatusesForSelect"
                                    v-model="todo.status"
                                    v-bind:currentOption="todo.status" />
                            </div>
                            <div class="col-md-6">
                                <div class="flex flex-direction-reverse">
                                    <a @click="addTodo()" class="btn-rounded btn-auto">{{ translate('message.add_new_todo') }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /// End ToDos /// -->

                    <hr class="double">

                    <!-- /// Infos /// -->
                    <h3>{{ translate('message.infos') }}</h3>

                    <div class="entries-wrapper" v-if="meeting.openInfos">
                        <div class="entry" v-for="info in meeting.openInfos">
                            <div class="entry-header flex flex-space-between flex-v-center">
                                <div class="entry-title">
                                    <h4>{{ info.topic }}</h4> |
                                    {{ translate('message.expiry_date') }}: <b :class="{'danger-color': info.isExpired}">{{ info.expiresAt | date }}</b> |
                                    {{ translate('message.category') }}: <b v-if="info.infoCategory">{{ translate(info.infoCategoryName) }}</b><b v-else>-</b>
                                </div>
                                <div class="entry-buttons">
                                    <button @click="initEditInfo(info)" class="btn btn-rounded second-bg btn-auto btn-md" data-toggle="modal" type="button">{{ translate('message.edit') }}</button>
                                    <button @click="initDeleteInfo(info)" type="button" class="btn btn-rounded btn-auto btn-md danger-bg" >{{ translate('message.delete') }}</button>
                                </div>
                            </div>
                            <div class="entry-responsible flex flex-v-center">
                                <user-avatar
                                        size="small"
                                        :name="info.responsibilityFullName"
                                        :url="info.responsibilityAvatarUrl"/>
                                <div>
                                    {{ translate('message.responsible') }}:
                                    <b>{{ info.responsibilityFullName }}</b>
                                </div>
                            </div>
                            <div class="entry-body" v-html="info.description"></div>
                        </div>
                    </div>

                    <input-field type="text"
                        v-bind:label="translate('placeholder.topic')"
                        v-model="info.topic"
                        v-bind:content="info.topic" />
                    <error at-path="topic" scope="info"/>
                    <div class="form-group">
                        <editor
                            id="info-description"
                            height="200px"
                            label="placeholder.info_description"
                            v-model="info.description" />
                    </div>
                    <error at-path="description" scope="info"/>
                    <div class="row">
                        <div class="form-group">
                            <div class="col-md-6">
                                <member-search v-model="info.responsibility" v-bind:placeholder="translate('placeholder.responsible')" v-bind:singleSelect="true"></member-search>
                            </div>
                            <div class="col-md-6">
                                <div class="input-holder right">
                                    <label class="active">{{ translate('label.expiry_date') }}</label>
                                    <date-field v-model="info.expiresAt"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group last-form-group">
                            <div class="col-md-6">
                                <select-field
                                    v-bind:title="'label.category'"
                                    v-bind:options="infoCategoriesForDropdown"
                                    v-model="info.infoCategory"
                                    v-bind:currentOption="info.infoCategory" />
                                <error at-path="infoCategory" scope="info"/>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group last-form-group">
                            <div class="col-md-6"></div>
                            <div class="col-md-6">
                                <div class="flex flex-direction-reverse">
                                    <a @click="addInfo()" class="btn-rounded btn-auto">{{ translate('message.add_new_info') }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /// End ToDos /// -->

                    <hr class="double">

                    <!-- /// Actions /// -->
                    <div class="flex flex-space-between">
                        <router-link :to="{name: 'project-meetings'}" class="btn-rounded btn-auto btn-auto disable-bg">{{ translate('button.cancel') }}</router-link>
                        <a
                                v-if="canSave"
                                @click="saveMeeting()"
                                class="btn-rounded btn-auto second-bg">{{ translate('button.save_meeting') }}</a>
                    </div>
                    <!-- /// End Actions /// -->
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="create-meeting page-section">
                <!-- /// Header /// -->
                <div class="margintop20 text-right buttons">
                    <a
                            v-if="canSave"
                            @click="saveMeeting()"
                            class="btn-rounded btn-auto">{{ translate('button.save_meeting') }}</a>
                    <a @click="newMeeting()" class="btn-rounded btn-auto second-bg">{{ translate('button.new_meeting') }}</a>
                    <a @click="deleteMeetingModal = true" class="btn-rounded btn-auto danger-bg">{{ translate('button.delete_meeting') }}</a>
                </div>
                <div class="margintop20 text-right">
                    <a @click="editDistributionListModal = (details.distributionList && details.distributionList.key)" class="btn-rounded btn-auto btn-md btn-empty">{{ translate('button.edit_distribution_list') }}</a>
                </div>
                <!-- /// End Header /// -->

                <div class="flex flex-v-center flex-space-between">
                    <div>
                        <h3>{{ translate('message.participants') }}</h3>
                    </div>
                    <!--<div class="buttons">
                        <router-link :to="{name: 'project-organization-edit'}" class="btn-rounded btn-auto btn-md btn-empty">{{ translate('button.edit_distribution_list') }}</router-link>
                    </div>-->
                </div>

                <meeting-participants v-model="selectedParticipants" />
            </div>
        </div>
    </div>
</template>

<script>
import InputField from '../../_common/_form-components/InputField';
import SelectField from '../../_common/_form-components/SelectField';
import MemberSearch from '../../_common/MemberSearch';
import EditIcon from '../../_common/_icons/EditIcon';
import DeleteIcon from '../../_common/_icons/DeleteIcon';
import {mapGetters, mapActions} from 'vuex';
import moment from 'moment';
import {createFormData} from '../../../helpers/meeting';
import MultiSelectField from '../../_common/_form-components/MultiSelectField';
import MeetingModals from './MeetingModals';
import MeetingParticipants from './MeetingParticipants';
import Error from '../../_common/_messages/Error.vue';
import ViewIcon from '../../_common/_icons/ViewIcon';
import router from '../../../router';
import Editor from '../../_common/Editor';
import Modal from '../../_common/Modal';
import EditDistributionListModal from '../../_common/EditDistributionListModal';
import UserAvatar from '../../_common/UserAvatar';
import MeetingDecisionForm from './Form/DecisionForm';
import DateField from '../../_common/_form-components/DateField';
import Attachments from '../../_common/Attachments';
import {createFormDataDecision} from '../../../helpers/decision';
import DataPicker from 'vue2-datepicker';
import 'vue2-datepicker/index.css';
import '../../../css/vue-dat-time-picker-custom.css';
import Vue from 'vue';
import {timepicerMask} from '../../../util/functions';

export default {
    components: {
        Attachments,
        DateField,
        MeetingDecisionForm,
        UserAvatar,
        Editor,
        InputField,
        SelectField,
        MemberSearch,
        EditIcon,
        DeleteIcon,
        ViewIcon,
        moment,
        MultiSelectField,
        MeetingModals,
        MeetingParticipants,
        Error,
        Modal,
        EditDistributionListModal,
        DataPicker,
    },
    methods: {
        ...mapActions([
            'getDistributionLists', 'getMeetingCategories', 'getProjectMeeting', 'createMeetingObjective', 'getTodoStatuses',
            'createProjectMeeting', 'getMeetingAgendas', 'updateProjectMeeting', 'editMeetingObjective', 'deleteMeetingObjective',
            'createMeetingAgenda', 'createMeetingDecision', 'createMeetingTodo', 'createInfo',
            'getInfoCategories', 'deleteProjectMeeting',
        ]),
        onUploading(uploading) {
            this.isUploading = uploading;
        },
        translateMeetingName(name) {
            return name
                ? name
                    .split('|')
                    .map(i => this.translate(i))
                    .join(' | ')
                : ''
            ;
        },
        getMediaFile(media) {
            if (!media.id) {
                return;
            }

            const url = Routing.generate('app_api_media_download', {id: media.id});
            Vue.http.get(url, {responseType: 'blob'})
                .then((response) => {
                    if (response.status !== 200) {
                        return;
                    }

                    let options = {};
                    if (response.headers && response.headers.map && response.headers.map['content-type']) {
                        options.type = response.headers.map['content-type'][0];
                    }

                    let blob = new Blob([response.body], options);
                    let a = document.createElement('a');
                    a.href = window.URL.createObjectURL(blob);
                    a.download = media.originalName;
                    document.body.appendChild(a);
                    a.click();

                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                });
        },
        refreshAgendaTable() {
            this.getMeetingAgendas({
                meetingId: this.$route.params.meetingId,
                apiParams: {
                    page: this.agendasActivePage,
                },
            });
        },
        setModals(value) {
            this.showEditObjectiveModal = value;
            this.showDeleteObjectiveModal = value;
            this.showEditAgendaModal = value;
            this.showDeleteAgendaModal = value;
            this.showEditDecisionModal = value;
            this.showDeleteDecisionModal = value;
            this.showEditTodoModal = value;
            this.showDeleteTodoModal = value;
            this.showEditInfoModal = value;
            this.showDeleteInfoModal = value;
        },
        changeAgendasPage: function(page) {
            this.agendasActivePage = page;
            this.getMeetingAgendas({
                meetingId: this.$route.params.meetingId,
                apiParams: {
                    page: this.agendasActivePage,
                },
            });
        },
        addObjective: function() {
            this.createMeetingObjective({
                id: this.$route.params.meetingId,
                description: this.objectiveDescription,
            });
            this.objectiveDescription = null;
        },
        initEditObjective: function(objective) {
            this.showEditObjectiveModal = true;
            this.editObjectiveObject = {
                id: objective.id,
                description: objective.description,
            };
        },
        initDeleteObjective: function(objective) {
            this.showDeleteObjectiveModal = true;
            this.editObjectiveObject = {id: objective.id};
        },
        addAgenda: function() {
            this.createMeetingAgenda({
                id: this.$route.params.meetingId,
                meeting: this.$route.params.meetingId,
                topic: this.agenda.topic,
                responsibility: this.agenda.responsibility.length > 0 ? this.agenda.responsibility[0] : null,
                duration: this.agenda.duration,
            }).then((response) => {
                if (response.body && response.body.error && response.body.messages) {
                    return;
                }
                this.agenda.responsibility = [];
                this.agenda.topic = null;
                this.agenda.duration = null;
            }).catch((response) => {
                this.agendaErrors = response.body.messages;
            });
        },
        initEditAgenda: function(agenda) {
            this.showEditAgendaModal = true;
            this.editAgendaObject = {
                id: agenda.id,
                topic: agenda.topic,
                responsibility: agenda.responsibility,
                responsibilityFullName: agenda.responsibilityFullName,
                start: {
                    HH: moment(agenda.start, 'HH:mm').format('HH'),
                    mm: moment(agenda.start, 'HH:mm').format('mm'),
                },
                duration: agenda.duration,
            };
        },
        initDeleteAgenda: function(agenda) {
            this.showDeleteAgendaModal = true;
            this.editAgendaObject = {id: agenda.id};
        },
        addDecision() {
            let data = {
                title: this.decision.title,
                description: this.decision.description,
                done: this.decision.done,
                responsibility: this.decision.responsibility,
                dueDate: moment(this.decision.dueDate, 'DD-MM-YYYY').format('DD-MM-YYYY'),
                date: moment(this.decision.date, 'DD-MM-YYYY').format('DD-MM-YYYY'),
                meeting: this.$route.params.meetingId,
                project: this.$route.params.id,
                medias: this.decision.medias,
                distributionList: this.details.distributionList && this.details.distributionList.key
                    ? this.details.distributionList.key
                    : null,
            };

            let formData = createFormDataDecision(data);
            this.createMeetingDecision({
                data: formData,
                meetingId: this.$route.params.meetingId,
            }).then(() => {
                this.decisionErrors = {};
                this.decision = this.defaultDecision;
                this.getProjectMeeting(this.$route.params.meetingId);
            }).catch((response) => {
                this.decisionErrors = response.body.messages;
            });
        },
        initEditDecision: function(decision) {
            this.editDecisionObject = {
                id: decision.id,
                title: decision.title,
                description: decision.description,
                responsibility: decision.responsibility,
                responsibilityFullName: decision.responsibilityFullName,
                dueDate: decision.dueDate ? moment(decision.dueDate).toDate() : new Date(),
                date: decision.date ? moment(decision.date).toDate() : new Date(),
                done: decision.done,
                project: this.$route.params.id,
                meeting: this.$route.params.meetingId,
                medias: decision.medias,
            };
            this.showEditDecisionModal = true;
        },
        initDeleteDecision: function(decision) {
            this.showDeleteDecisionModal = true;
            this.editDecisionObject = {id: decision.id, meeting: this.$route.params.meetingId};
        },
        addTodo: function() {
            this.createMeetingTodo({
                id: this.$route.params.meetingId,
                title: this.todo.title,
                description: this.todo.description,
                responsibility: this.todo.responsibility.length > 0 ? this.todo.responsibility[0] : null,
                dueDate: moment(this.todo.dueDate, 'DD-MM-YYYY').format('DD-MM-YYYY'),
                status: this.todo.status ? this.todo.status.key : null,
                meeting: this.$route.params.meetingId,
                distributionList: this.details.distributionList && this.details.distributionList.key
                    ? this.details.distributionList.key
                    : null,
            });
            this.todo.responsibility = [];
            this.todo.title = null;
        },
        initEditTodo: function(todo) {
            this.showEditTodoModal = true;
            this.editTodoObject = {
                id: todo.id,
                title: todo.title,
                description: todo.description,
                responsibility: [todo.responsibility],
                responsibilityFullName: todo.responsibilityFullName,
                dueDate: todo.dueDate ? moment(todo.dueDate).toDate() : new Date(),
                status: {key: todo.status, label: this.translate(todo.statusName)},
                meeting: this.$route.params.meetingId,
            };
        },
        initDeleteTodo: function(todo) {
            this.showDeleteTodoModal = true;
            this.editTodoObject = {id: todo.id, meeting: this.$route.params.meetingId};
        },
        addInfo: function() {
            const data = {
                // id: this.$route.params.meetingId,
                topic: this.info.topic,
                description: this.info.description,
                responsibility: this.info.responsibility.length ? this.info.responsibility[0] : null,
                expiresAt: this.$formatToSQLDate(this.info.expiresAt),
                infoCategory: this.info.infoCategory ? this.info.infoCategory.key : null,
                meeting: this.$route.params.meetingId,
                distributionList: this.details.distributionList && this.details.distributionList.key
                    ? this.details.distributionList.key
                    : null,
            };
            const projectId = this.$route.params.id;
            this.createInfo({projectId, data});
            this.info.topic = null;
            this.info.responsibility = [];
        },
        initEditInfo: function(info) {
            this.showEditInfoModal = true;
            this.editInfoObject = {
                id: info.id,
                topic: info.topic,
                description: info.description,
                responsibility: [info.responsibility],
                responsibilityFullName: info.responsibilityFullName,
                expiresAt: info.expiresAt ? moment(info.expiresAt).toDate() : new Date(),
                infoCategory: {key: info.infoCategory, label: info.infoCategoryName},
                meeting: this.$route.params.meetingId,
            };
        },
        initDeleteInfo: function(info) {
            this.showDeleteInfoModal = true;
            this.editInfoObject = {id: info.id, meeting: this.$route.params.meetingId};
        },
        newMeeting() {
            router.push({
                name: 'project-meetings-create-meeting',
                params: {
                    id: this.$route.params.id,
                },
            });
        },
        deleteMeeting() {
            this.deleteMeetingModal = false;
            this.deleteProjectMeeting(this.$route.params.meetingId);
        },
        saveMeeting() {
            let data = {
                name: this.name,
                distributionLists: this.details.distributionList
                    ? [this.details.distributionList]
                    : null,
                meetingCategory: this.details.category,
                date: this.schedule.meetingDate,
                start: {
                    HH: moment(this.schedule.startTime).format('HH'),
                    mm: moment(this.schedule.startTime).format('mm'),
                },
                end: {
                    HH: moment(this.schedule.endTime).format('HH'),
                    mm: moment(this.schedule.endTime).format('mm'),
                },
                location: this.location,
                medias: this.medias,
                meetingParticipants: this.selectedParticipants.map(participant => {
                    return {
                        user: participant.user,
                        isPresent: participant.isPresent,
                        inDistributionList: participant.inDistributionList,
                    };
                }),
            };

            this
                .updateProjectMeeting({
                    id: this.$route.params.meetingId,
                    data: createFormData(data),
                })
                .then(
                    (response) => {
                        if (response.body && response.body.error && response.body.messages) {
                            this.$flashError('message.unable_to_save');
                        } else {
                            this.showSaved = true;
                            this.$flashSuccess('message.saved');
                        }
                    },
                    () => {
                        this.$flashError('message.unable_to_save');
                    }
                )
            ;
        },
        distributionListUpdated(distributionList) {
            this.details.distributionList = {key: distributionList.id, label: distributionList.name};
        },
        onDecisionUploading(uploading) {
            this.isDecisionUploading = uploading;
        },
    },
    computed: {
        ...mapGetters([
            'distributionListsForSelect',
            'meetingCategoriesForSelect',
            'infoCategoriesForDropdown',
            'todoStatusesForSelect',
            'meeting',
            'meetingAgendas',
            'distributionLists',
            'meetingParticipants',
            'validationMessages',
            'validationOrigin',
            'decisionStatusByValue',
            'projectMaxUploadFileSize',
            'validationMessagesFor',
            'project',
        ]),
        canSave() {
            return !this.isUploading && !this.isDecisionUploading;
        },
        mediasValidationMessages() {
            let messages = this.validationMessagesFor('medias');
            let out = [];

            Object.keys(messages).forEach((index) => {
                out[index] = messages[index].file;
            });

            return out;
        },
        agendasPerPage: function() {
            return this.meetingAgendas.pageSize;
        },
        agendasPages: function() {
            return Math.ceil(this.meetingAgendas.totalItems / this.agendasPerPage);
        },
    },
    created() {
        this.getDistributionLists({projectId: this.$route.params.id});
        this.getMeetingCategories();
        this.getTodoStatuses();
        this.getInfoCategories();
        this.getProjectMeeting(this.$route.params.meetingId);
        this.getMeetingAgendas({
            meetingId: this.$route.params.meetingId,
            apiParams: {
                page: this.agendasActivePage,
            },
        });
    },
    data() {
        let defaultDecision = {
            title: null,
            description: null,
            responsibility: null,
            dueDate: new Date(),
            date: new Date(),
            done: false,
            medias: [],
        };

        return {
            showSaved: false,
            agendasActivePage: 1,
            participantsPerPage: 10,
            participantsPages: 0,
            location: '',
            objectiveDescription: '',
            medias: [],
            name: '',
            schedule: {
                meetingDate: new Date(),
                startTime: null,
                endTime: null,
            },
            details: {
                distributionList: null,
                category: null,
            },
            agenda: {
                topic: null,
                responsibility: [],
                duration: null,
            },
            defaultDecision: defaultDecision,
            decision: defaultDecision,
            decisionErrors: {},
            todo: {
                title: null,
                description: null,
                responsibility: [],
                dueDate: new Date(),
                status: null,
            },
            info: {
                topic: null,
                description: null,
                responsibility: [],
                expiresAt: new Date(),
                infoCategory: null,
            },
            decisionDescription: '',
            editDecisionDescription: '',
            todoDescription: '',
            editTodoDescription: '',
            infoDescription: '',
            editInfoDescription: '',
            showEditObjectiveModal: false,
            showDeleteObjectiveModal: false,
            editObjectiveObject: {},
            showEditAgendaModal: false,
            showDeleteAgendaModal: false,
            editAgendaObject: {},
            showEditDecisionModal: false,
            showDeleteDecisionModal: false,
            editDecisionObject: {},
            showEditTodoModal: false,
            showDeleteTodoModal: false,
            editTodoObject: {},
            showEditInfoModal: false,
            showDeleteInfoModal: false,
            editInfoObject: {},
            participants: [],
            decisionDescriptionEditor: null,
            todoDescriptionEditor: null,
            infoDescriptionEditor: null,
            DECISION_VALIDATION_ORIGIN: 'decision',
            TODO_VALIDATION_ORIGIN: 'todo',
            INFO_VALIDATION_ORIGIN: 'info',
            selectedParticipants: [],
            deleteMeetingModal: false,
            editDistributionListModal: null,
            isUploading: false,
            isDecisionUploading: false,
        };
    },
    watch: {
        'details.distributionList': {
            handler: function(value) {
                this.selectedParticipants = [];

                if (!value || !value.key) {
                    return;
                }

                this.distributionLists.forEach(distributionList => {
                    if (value.key !== distributionList.id) {
                        return;
                    }

                    distributionList
                        .users
                        .filter(u => this.selectedParticipants.map(sp => sp.user).indexOf(u.id) === -1)
                        .forEach(user => {
                            let projectUser = user.projectUsers.filter((item) => {
                                return item.project !== this.$route.params.id;
                            });
                            let participant = this.meeting.meetingParticipants.filter(mp => mp.user === user.id);

                            this.selectedParticipants.push({
                                user: user.id,
                                userFullName: user.firstName + ' ' + user.lastName,
                                userAvatar: user.avatarUrl,
                                departments: projectUser.length ? projectUser[0].projectDepartmentNames : [],
                                isPresent: participant.length && participant[0].isPresent,
                                inDistributionList: participant.length && participant[0].inDistributionList,
                            });
                        });
                });
            },
            deep: true,
        },
        'distributionLists': {
            handler() {
                // force an update of the list when the distributionLists are loaded
                if (this.details.distributionList && this.details.distributionList.key) {
                    this.details.distributionList = {
                        key: this.details.distributionList.key,
                        label: this.details.distributionList.label,
                    };
                }
            },
            deep: true,
        },
        meeting(value) {
            this.name = this.meeting.name;
            if (this.meeting.distributionLists.length > 0) {
                let item = this.meeting.distributionLists[0];
                this.details.distributionList = {'key': item.id, 'label': item.name};
            }
            this.details.category = this.meeting.meetingCategory
                ? {key: this.meeting.meetingCategory, label: this.meeting.meetingCategoryName}
                : null
            ;
            this.schedule.meetingDate = moment(this.meeting.date).toDate();
            this.schedule.startTime = {
                HH: moment(this.meeting.start, 'HH:mm').format('HH'),
                mm: moment(this.meeting.start, 'HH:mm').format('mm'),
            };
            this.schedule.endTime = {
                HH: moment(this.meeting.end, 'HH:mm').format('HH'),
                mm: moment(this.meeting.end, 'HH:mm').format('mm'),
            };
            this.location = this.meeting.location;
            this.medias = this.meeting.medias;
        },
        showSaved(value) {
            if (value === true) {
                router.push({
                    name: 'project-meetings',
                    params: {
                        id: this.$route.params.id,
                    },
                });
            }
        },
    },
    mounted() {
        timepicerMask();
    },
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
    @import '../../../css/_mixins';
    @import '~theme/variables';

    .title {
        position: relative;
        top: 15px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 700;
    }

    .action-list {
        margin-bottom: 15px;
        list-style-type: none;

        li {
            margin-bottom: 15px;
            position: relative;
            padding-right: 60px;
            padding-bottom: 15px;
            border-bottom: 1px solid $darkerColor;

            .list-item-description {
                position: relative;
                padding-left: 30px;

                &:before {
                    content: '';
                    display: block;
                    position: absolute;
                    @include border-radius(50%);
                    background-color: $lightColor;
                    width: 10px;
                    height: 10px;
                    left: 0;
                    top: 0;
                    margin-top: 0.3em;
                }
            }

            .list-item-actions {
                position: absolute;
                top: 0;
                right: 0;
                width: 60px;
                text-align: right;

                a {
                    margin-left: 10px;
                }
            }

            &:last-child {
                margin-bottom: 0;
            }
        }
    }

    .actions {
        margin: 30px 0;
    }

    .table-wrapper {
        width: 100%;
        padding-bottom: 40px;
    }

    .avatars {
        > div {
            height: 34px;
            padding: 2px 0;
            display: inline-block;
        }

        span {
            margin-left: 10px;
            line-height: 34px;
        }
    }

    .avatar {
        width: 30px;
        height: 30px;
        @include border-radius(50%);
        background-size: cover;
        display: inline-block;
        margin-right: 5px;

        &:last-child {
            margin-right: 0;
        }
    }

    .topic {
        white-space: normal;
        text-transform: none;
    }

    .user-avatar {
        width: 30px;
        height: 30px;
        display: inline-block;
        margin: 0 10px 0 0;
        position: relative;
        top: -2px;
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
        @include border-radius(50%);
    }

    p {
        margin-bottom: 20px;
    }

    .entry {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid $darkerColor;

        .entry-header {
            .entry-title {
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-size: 10px;
                margin-bottom: 10px;

                h4 {
                    display: inline-block;
                    text-transform: none;
                    letter-spacing: 0;
                    margin: 0;
                    font-weight: 700;
                }
            }

            .done {
                color: $secondColor;
            }

            .undone {
                color: $dangerColor;
            }

            .entry-buttons {
                text-align: right;

                .btn {
                    margin: 0 0 10px 10px;
                }
            }
        }

        .entry-responsible {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 10px;
            line-height: 1.5em;

            b {
                display: block;
                font-size: 12px;
            }
        }

        .entry-body {
            padding: 10px 0 0 0;

            ul {
                list-style-type: disc;
                list-style-position: inside;

                &:last-child {
                    margin-bottom: 0;
                }
            }

            ol {
                list-style-type: decimal;
                list-style-position: inside;
                padding: 0;

                &:last-child {
                    margin-bottom: 0;
                }
            }

            img {
                @include box-shadow(0, 0, 20px, $darkColor);
            }

            .title {
                font-weight: bold;
                margin-bottom: 5px;
            }

            .cost {
                text-transform: uppercase;
                color: $lightColor;
                letter-spacing: 0.1em;

                b {
                    color: $lighterColor;
                }
            }

            p {
                &:last-child {
                    margin-bottom: 0;
                }
            }
        }
    }

    .new-comment {
        .footer-buttons {
            margin-top: 15px;
        }
    }

    .buttons {
      a {
        margin: 5px 0 5px 10px;
      }
    }

    .attachments {
        margin: 0 0 20px;
    }

    .attachment {
        padding: 10px 20px;
        background-color: $fadeColor;
        margin-top: 3px;
        color: $secondColor;
        position: relative;

        .view-icon {
            display: inline;
            margin-right: 10px;
            position: relative;
            top: 3px;

            svg {
                width: 18px;
            }
        }
        .attachment-name {
            a {
                cursor: pointer;
            }
        }
    }
</style>

